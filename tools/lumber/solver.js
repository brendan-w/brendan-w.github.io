function emit(t,e){postMessage({type:t,data:e})}function clone(t){if(null==t||"object"!=typeof t)return console.error("unimplemented clone() of non-object type"),t;var e=t.constructor();for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function sources_left(t){for(var e=0,n=0;n<t.sources.length;n++)e+=t.sources[n].quantity;return e}function cuts_left(t){for(var e=0,n=0;n<t.cuts.length;n++)e+=t.cuts[n].quantity;return e}function make_board(t,e){return{source_index:e,space_left:t.sources[e].length,cut_indices:[]}}function clone_board(t){return{source_index:t.source_index,space_left:t.space_left,cut_indices:t.cut_indices.slice(0)}}function clone_layout(t){var e=[];return t.forEach(function(t){e.push(clone_board(t))}),e}function loss_in_layout(t){var e=0;return t.forEach(function(t){var n=t.space_left;n=0>n?0:n,e+=n}),e}function allocate_cuts(t,e){e.cut_indices.forEach(function(e){t.cuts[e].quantity--})}function deallocate_cuts(t,e){e.cut_indices.forEach(function(e){t.cuts[e].quantity++})}function clumping_in_layout(){}function descending_length(t,e){return e.length-t.length}function run(t){handle_infinity(t),t.sources.sort(descending_length),t.cuts.sort(descending_length);var e=null;switch(t.settings.mode){default:case"optimal":e=optimal.run(t);break;case"suboptimal":e=suboptimal.run(t)}e?emit("success",{settings:t.settings,layout:resolve_to_user_objects(t,e)}):emit("failure","Failed to compute layout. It might be impossible.")}function handle_infinity(t){var e=cuts_left(t);t.sources.forEach(function(t){t.quantity==1/0&&(t.quantity=e)})}function resolve_to_user_objects(t,e){var n=[];return e.forEach(function(e){var c=clone(t.sources[e.source_index]);delete c.quantity,c.loss=e.space_left,c.cuts=[],e.cut_indices.forEach(function(e){var n=clone(t.cuts[e]);delete n.quantity,c.cuts.push(n)}),c.cuts.sort(descending_length),n.push(c)}),n.sort(descending_length),n}var optimal={run:function(t){var e,n=null;return optimal.choose_source(t,[],function(t){var c=loss_in_layout(t);(!n||e>c)&&(n=t,e=c)}),n},choose_source:function(t,e,n){cuts_left(t)>0?t.sources.forEach(function(c,o){if(0!=c.quantity){var u=optimal.fill_board(t,make_board(t,o));0!=u.cut_indices.length&&(c.quantity--,e.push(u),allocate_cuts(t,u),optimal.choose_source(t,e,n),deallocate_cuts(t,u),e.pop(),c.quantity++)}}):n(clone_layout(e))},fill_board:function(t,e){var n;return optimal.cut_board(t,e,function(t){(!n||t.space_left<n.space_left)&&(n=t)}),n},cut_board:function(t,e,n){e.space_left>0&&cuts_left(t)>0?t.cuts.forEach(function(c,o){if(0!=c.quantity){if(e.space_left<c.length)return void n(clone_board(e));var u=e.space_left;c.quantity--,e.cut_indices.push(o),e.space_left-=c.length+t.settings.kerf,optimal.cut_board(t,e,n),e.space_left=u,e.cut_indices.pop(),c.quantity++}}):n(clone_board(e))}},suboptimal={run:function(t){for(var e,n=[],c=cuts_left(t);(e=cuts_left(t))>0&&sources_left(t)>0;){var o=c-e;emit("progress",o/c);var u=suboptimal.choose_board(t);if(0==u.cut_indices.length)return null;t.sources[u.source_index].quantity--,n.push(u),allocate_cuts(t,u)}return cuts_left(t)>0&&(n=null),n},choose_board:function(t){var e;return t.sources.forEach(function(n,c){if(0!=n.quantity){var o=optimal.fill_board(t,make_board(t,c));(!e||o.space_left<e.space_left)&&(e=o)}}),e}};onmessage=function(t){run(t.data)};